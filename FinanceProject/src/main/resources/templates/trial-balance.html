<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trial Balance</title>
    <style th:inline="css">
        /* ... (keep existing styles) ... */
        .container  { width:90%; margin:0 auto; }
        .report-box { background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
        h1          { margin-bottom:10px; }
        .date-box   { margin-bottom:20px; }
        .date-box label { margin-right:5px; }
        .btn-green  { background:#28a745; color:#fff; padding:8px 15px; border:none; border-radius:4px; cursor:pointer; margin-left: 10px; }
        .tab-btn    { background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; margin-right: 5px; margin-bottom:15px; cursor: pointer;}
        .tab-btn.active { background-color: #0056b3; font-weight: bold; }
        table       { border-collapse: collapse; width: 100%; }
        /* Make table gridless */
        table, th, td { border : none !important; }
        thead th    { background-color: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600;}
        /* Style for individual account rows (not bold, normal indent) */
        tbody td    { padding: 12px 15px; border-bottom: 1px solid #dee2e6;}
        /* Style for total row (bold) */
        tfoot td    { font-weight:bold; padding: 12px 15px; border-top: 2px solid #343a40;}
        .amount     { text-align: right; }
         /* Add specific styling for bolding and indentation */
         .bold-item { font-weight: bold; }
         /* Trial balance usually doesn't indent accounts, but keeping structure if needed */
         .indent { padding-left: 25px; }

         /* Deep green for debits */
         .debit-value { color: #006400; /* Slightly deep green */ }
        /* Deep red for credits */
        .credit-value { color: #8B0000; /* Slightly deep red */ }

        .report-actions { /* Style for the button container */
            position: absolute; /* Position relative to the body or a positioned ancestor */
            top: 120px; /* Adjust based on navbar height */
            left: 20px; /* Adjust as needed */
            z-index: 10; /* Ensure buttons are above other content */
            display: flex;
            gap: 10px;
            margin-bottom: 15px; /* Add some space below buttons */
        }
        .report-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-save { background-color: #28a745; color: white; } /* Green */
        .btn-email { background-color: #17a2b8; color: white; } /* Teal */
        .btn-print { background-color: #6c757d; color: white; } /* Grey */

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 50%; /* Could be more or less, depending on screen size */
            border-radius: 5px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-body select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .modal-footer {
            text-align: right;
        }
         .modal-footer button {
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-confirm { background-color: #007bff; color: white; border: none;}
        .btn-cancel { background-color: #6c757d; color: white; border: none;}

        /* Add hover effects */
        .report-actions button:hover { opacity: 0.9; }
        .modal-footer button:hover { opacity: 0.9; }
        .container { position: relative; padding-top: 50px; } /* Add padding to container if buttons overlap */

        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px; /* Keep padding */
            }

            /* Center Title and Date */
            .printable-area h1, .printable-area h3.report-date {
                 visibility: visible !important;
                 text-align: center;
                 width: 100%;
                 margin-left: auto;
                 margin-right: auto;
                 margin-bottom: 5px; /* Adjust spacing */
             }
             .printable-area h3.report-date {
                 font-size: 12pt;
                 font-weight: normal;
                 margin-bottom: 20px;
             }

            /* Basic table styling */
            .printable-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
                font-size: 10pt;
            }

            /* --- Modification Start --- */

            /* Prevent tfoot repetition */
            .printable-area tfoot {
                display: table-row-group; /* Treat footer like body rows for paging */
            }

            /* Header Styles & Alignment */
            .printable-area thead th {
                background-color: #343a40 !important; /* Dark background */
                color: white !important;            /* White text */
                font-weight: bold;
                padding: 8px 8px;
                border-bottom: 2px solid #343a40;
                /* Default text-align removed or overridden below */
            }
            /* Align 'Account' header left */
            .printable-area thead th:first-child {
                 text-align: left;
            }
            /* Align 'Debit' and 'Credit' headers right */
            .printable-area thead th.amount {
                 text-align: right;
            }

            /* Body & Footer Cell Styles */
            .printable-area td {
                 border: none !important; /* Remove cell borders */
                 padding: 5px 8px;
                 text-align: left; /* Default left align for body */
            }
             .printable-area tbody td {
                 border-bottom: 1px solid #eee; /* Keep light lines between body rows */
             }

            /* Amount Alignment (Body and Footer) */
            .printable-area .amount,
            .printable-area .debit-value,  /* Ensure alignment applies */
            .printable-area .credit-value { /* Ensure alignment applies */
                 text-align: right;
            }

            /* Total Row Styles */
            .printable-area tfoot td {
                font-weight: bold;
                border-top: 1px solid #343a40; /* Line above totals */
                padding-top: 8px;
            }
            /* Ensure tfoot amounts align right (redundant but safe) */
             .printable-area tfoot td.amount {
                  text-align: right;
             }

            /* --- Modification End --- */


            /* Hide elements that should never print */
            .report-actions, .date-box, #snapshotButtons, header, .modal, .tab-btn, .btn-green {
                 display: none !important;
                 visibility: hidden !important;
            }
            .report-box {
                visibility: visible;
                 box-shadow: none;
                 border: none;
            }
        }
    </style>
</head>
<body>
  <header th:replace="fragments/navbar :: navbar"></header>

  <div class="report-actions">
      <button class="btn-save" onclick="openReportModal('save', 'Trial Balance', 'TB')">Save</button>
      <button class="btn-email" onclick="openReportModal('email', 'Trial Balance', 'TB')">Email</button>
      <button class="btn-print" onclick="openReportModal('print', 'Trial Balance', 'TB')">Print</button>
  </div>

  <div class="container">
      <div class="report-box">
        <div class="printable-area">
          <h1 style="text-align: center;">Trial Balance</h1>
          <h3 class="report-date" style="text-align: center; font-weight: normal; margin-bottom: 20px; visibility: visible;"
          th:if="${startDate != null}"
          th:text="${startDate.equals(endDate) ? 'As of ' + #temporals.format(startDate, 'MM/dd/yyyy') : 'For the period ' + #temporals.format(startDate, 'MM/dd/yyyy') + ' to ' + #temporals.format(endDate, 'MM/dd/yyyy')}">
          </h3>

          <form th:action="@{/reports/trial-balance}" method="get" class="date-box">
              From: <input type="date" name="startDate" th:value="${startDate}" required>
              To:   <input type="date" name="endDate"   th:value="${endDate}"   required>
              <button type="submit" class="btn-green">Generate Report</button>
            </form>

            <div id="snapshotButtons" th:if="${snapshots}">
              <button th:each="s: ${snapshots}" class="tab-btn"
                      th:classappend="${s.id == snapshotId} ? 'active' : ''"
                      th:onclick="'window.location.href=\'' + @{/reports/trial-balance(snapshotId=${s.id})} + '\''"
                      th:data-snapshot-id="${s.id}" th:data-snapshot-text="${s.text}"
                      th:text="${s.text}">
              </button>
            </div>
            
            <div id="reportDisplay" th:if="${rows != null and not #lists.isEmpty(rows)}">
              
                <table>
                  <thead>
                    <tr><th>Account</th><th class="amount">Debit</th><th class="amount">Credit</th></tr>
                  </thead>
                  <tbody>
                    <tr th:each="r: ${rows}" 
                        th:if="${(r.debit != null and r.debit.compareTo(T(java.math.BigDecimal).ZERO) != 0) or (r.credit != null and r.credit.compareTo(T(java.math.BigDecimal).ZERO) != 0)}">
                      <td th:text="${r.accountName}"></td>
                      <td class="amount debit-value"
                          th:text="${r.debit != null and r.debit.compareTo(T(java.math.BigDecimal).ZERO) != 0 ? #numbers.formatDecimal(r.debit, 1, 'COMMA', 2, 'POINT') : ''}">
                      </td>
                      <td class="amount credit-value"
                          th:text="${r.credit != null and r.credit.compareTo(T(java.math.BigDecimal).ZERO) != 0 ? #numbers.formatDecimal(r.credit, 1, 'COMMA', 2, 'POINT') : ''}">
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr class="total">
                      <td>Total</td>
                      <td class="amount debit-value" th:text="${debitTotal != null ? #numbers.formatDecimal(debitTotal, 1, 'COMMA', 2, 'POINT') : '0.00'}"></td>
                      <td class="amount credit-value" th:text="${creditTotal != null ? #numbers.formatDecimal(creditTotal, 1, 'COMMA', 2, 'POINT') : '0.00'}"></td>
                    </tr>
                  </tfoot>
                </table>
            </div>
            <div th:unless="${rows != null and not #lists.isEmpty(rows)}" style="margin-top: 20px;">
                <p>Please select a date range and click "Generate Report" or choose a saved report.</p>
            </div>
          </div>
      </div>
  </div>

  <div id="reportActionModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeReportModal()">&times;</span>
      <h2 id="modalTitle">Select Report</h2>
      <div class="modal-body">
        <p id="modalActionText">Please select the report version you want to perform the action on:</p>
        <select id="reportSnapshotSelect">
          </select>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeReportModal()">Cancel</button>
        <button class="btn-confirm" onclick="confirmReportAction()">Confirm</button>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
  /*<![CDATA[*/
      const reportModal = document.getElementById('reportActionModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalActionText = document.getElementById('modalActionText');
      const reportSelect = document.getElementById('reportSnapshotSelect');
      let currentAction = ''; // To store 'save', 'email', or 'print'
      let currentReportType = ''; // To store 'Trial Balance', 'Income Statement', etc.
      let currentReportAbbr = ''; // To store 'TB', 'IS', etc.

      // Get snapshot data from Thymeleaf model
      const availableSnapshots = /*[[${snapshots}]]*/ [];

      function openReportModal(action, reportType, reportAbbr) {
          currentAction = action;
          currentReportType = reportType;
          currentReportAbbr = reportAbbr;

          modalTitle.textContent = `Select ${currentReportType} to ${action}`;
          modalActionText.textContent = `Please select the ${currentReportType} version you want to ${action}:`;

          // Clear previous options
          reportSelect.innerHTML = '';

          // Populate select options with available snapshots for the current report type
          if (availableSnapshots && availableSnapshots.length > 0) {
              availableSnapshots.forEach(snapshot => {
                  // Ensure the snapshot button text starts with the current report abbreviation
                  if (snapshot.text.startsWith(reportAbbr)) {
                      const option = document.createElement('option');
                      option.value = snapshot.id;
                      option.textContent = snapshot.text; // Use the button text from the model
                      reportSelect.appendChild(option);
                  }
              });
          } else {
              const option = document.createElement('option');
              option.textContent = 'No saved reports available for this type.';
              option.disabled = true;
              reportSelect.appendChild(option);
              // Optionally disable confirm button if no reports
                document.querySelector('.btn-confirm').disabled = true;
          }
          // Ensure confirm button is enabled if options exist
          if (reportSelect.options.length > 0 && !reportSelect.options[0].disabled) {
              document.querySelector('.btn-confirm').disabled = false;
          }


          reportModal.style.display = 'block';
      }

      function closeReportModal() {
          reportModal.style.display = 'none';
      }

      function confirmReportAction() {
          const selectedSnapshotId = reportSelect.value;
          if (!selectedSnapshotId) {
              alert('Please select a report.');
              return;
          }

          console.log(`Action: ${currentAction}, Report Type: ${currentReportType}, Snapshot ID: ${selectedSnapshotId}`);

          // Close the modal first
          closeReportModal();

          // Perform action based on 'currentAction'
          if (currentAction === 'save') {
              // Trigger download - Needs backend endpoint /reports/download/{snapshotId}
              window.location.href = `/reports/download/${selectedSnapshotId}?reportType=${currentReportAbbr}`; // Pass reportType if needed for formatting
          } else if (currentAction === 'email') {
              // Option 1: Use mailto (simpler, relies on user client)
              // Generate file name based on report type and snapshot details
              const selectedOptionText = reportSelect.options[reportSelect.selectedIndex].text;
              const subject = `Financial Report: ${selectedOptionText}`;
              const body = `Please find the attached ${currentReportType} report (${selectedOptionText}).`;
              // Ideally, trigger backend to generate and attach, then provide a mailto link or confirmation.
              // For now, a simple mailto:
              const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
              //window.location.href = mailtoLink;
              // Option 2: Trigger backend to generate and email (more robust)
              fetch(`/reports/email/${selectedSnapshotId}`, { method: 'POST' }) // Needs backend endpoint
                .then(response => response.json()) // Or handle confirmation
                .then(data => {
                    if(data.success) {
                          alert(data.message || 'Email request sent successfully.');
                      } else {
                          alert(data.message || 'Failed to send email.');
                      }
                })
                .catch(err => {
                    console.error('Email error:', err);
                    alert('Error requesting email.');
                  });

          } else if (currentAction === 'print') {
            // Create a hidden iframe
            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'absolute';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            printFrame.name = 'printFrame';
            document.body.appendChild(printFrame);

            const printUrl = `/reports/print/${selectedSnapshotId}`;

            // Set the iframe's source to the print endpoint
            printFrame.src = printUrl;

            // Wait for the iframe to load
            printFrame.onload = function() {
                try {
                    // Get the iframe's window
                    const frameWindow = printFrame.contentWindow;
                    frameWindow.focus(); // Focus for some browsers
                    // Trigger print dialog on the iframe's content
                    frameWindow.print();

                    // Clean up: remove the iframe after a short delay (allows print dialog)
                    // Adjust delay if needed
                    setTimeout(() => {
                          document.body.removeChild(printFrame);
                    }, 1000); // 1 second delay

                } catch (error) {
                    console.error("Printing error:", error);
                    alert("Could not initiate print. Please try again.");
                    // Clean up even on error
                    document.body.removeChild(printFrame);
                }
            };

            // Handle potential loading errors in the iframe
            printFrame.onerror = function() {
                console.error("Failed to load print content into iframe.");
                alert("Failed to load report content for printing.");
                document.body.removeChild(printFrame);
            };
        }
      }

      // Close modal if user clicks outside of it
      window.onclick = function(event) {
          if (event.target == reportModal) {
              closeReportModal();
          }
      }
  /*]]>*/
  </script>
</body>
</html>